---
title: 自己追跡エンティティ - EF6
description: Entity Framework 6 での自己追跡エンティティ
author: ajcvickers
ms.date: 10/23/2016
uid: ef6/fundamentals/disconnected-entities/self-tracking-entities/index
ms.openlocfilehash: 56bcd79d0c9949b9ccc06efe4dbc5a36bb88b158
ms.sourcegitcommit: 0a25c03fa65ae6e0e0e3f66bac48d59eceb96a5a
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 10/14/2020
ms.locfileid: "92065551"
---
# <a name="self-tracking-entities"></a><span data-ttu-id="38d29-103">自己追跡エンティティ</span><span class="sxs-lookup"><span data-stu-id="38d29-103">Self-tracking entities</span></span>

> [!IMPORTANT]
> <span data-ttu-id="38d29-104">自己追跡エンティティ テンプレートの使用は現在お勧めしていません。</span><span class="sxs-lookup"><span data-stu-id="38d29-104">We no longer recommend using the self-tracking-entities template.</span></span> <span data-ttu-id="38d29-105">既存のアプリケーションをサポートするためにのみ引き続き使用できます。</span><span class="sxs-lookup"><span data-stu-id="38d29-105">It will only continue to be available to support existing applications.</span></span> <span data-ttu-id="38d29-106">アプリケーションで、エンティティの切断されたグラフを操作する必要がある場合は、代替の方法を検討してください。たとえば、コミュニティによってより積極的に開発された自己追跡エンティティに似たテクノロジである[追跡可能なエンティティ](https://trackableentities.github.io/)を使用するか、または、低レベルの変更追跡 API を使用してカスタム コードを記述してください。</span><span class="sxs-lookup"><span data-stu-id="38d29-106">If your application requires working with disconnected graphs of entities, consider other alternatives such as [Trackable Entities](https://trackableentities.github.io/), which is a technology similar to Self-Tracking-Entities that is more actively developed by the community, or writing custom code using the low-level change tracking APIs.</span></span>

<span data-ttu-id="38d29-107">Entity Framework ベースのアプリケーションでは、オブジェクトの変更はコンテキストによって追跡されます。</span><span class="sxs-lookup"><span data-stu-id="38d29-107">In an Entity Framework-based application, a context is responsible for tracking changes in your objects.</span></span> <span data-ttu-id="38d29-108">SaveChanges メソッドを使用して、データベースに変更を確定します。</span><span class="sxs-lookup"><span data-stu-id="38d29-108">You then use the SaveChanges method to persist the changes to the database.</span></span> <span data-ttu-id="38d29-109">n 層アプリケーションを使用する場合、エンティティ オブジェクトが通常コンテキストから切り離され、変更を追跡する方法およびそれらの変更をコンテキストにレポートする方法を決定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="38d29-109">When working with N-Tier applications, the entity objects are usually disconnected from the context and you must decide how to track changes and report those changes back to the context.</span></span> <span data-ttu-id="38d29-110">自己追跡エンティティ (STE) は、任意の層での変更を追跡し、その後これらの変更を保存するコンテキストに再生することができます。</span><span class="sxs-lookup"><span data-stu-id="38d29-110">Self-Tracking Entities (STEs) can help you track changes in any tier and then replay these changes into a context to be saved.</span></span>  

<span data-ttu-id="38d29-111">STE エンティティは、オブジェクト グラフに対する変更が行われる層でコンテキストを利用できない場合にのみ使用します。</span><span class="sxs-lookup"><span data-stu-id="38d29-111">Use STEs only if the context is not available on a tier where the changes to the object graph are made.</span></span> <span data-ttu-id="38d29-112">コンテキストを使用できる場合、変更の追跡のコンテキストが処理するために、STE を使用する必要はありません。</span><span class="sxs-lookup"><span data-stu-id="38d29-112">If the context is available, there is no need to use STEs because the context will take care of tracking changes.</span></span>  

<span data-ttu-id="38d29-113">このテンプレート項目は、2 つの .tt (テキスト テンプレート) ファイルを生成します。</span><span class="sxs-lookup"><span data-stu-id="38d29-113">This template item generates two .tt (text template) files:</span></span>  

- <span data-ttu-id="38d29-114">**\<model name\>.tt** ファイルによって、エンティティ型と、自己追跡エンティティが使用する変更追跡ロジックおよび自己追跡エンティティで状態設定が可能な拡張メソッドを含むヘルパー クラスが生成されます。</span><span class="sxs-lookup"><span data-stu-id="38d29-114">The **\<model name\>.tt** file generates the entity types and a helper class that contains the change-tracking logic that is used by self-tracking entities and the extension methods that allow setting state on self-tracking entities.</span></span>  
- <span data-ttu-id="38d29-115">**\<model name\>.Context.tt** ファイルによって、派生コンテキストと、**ObjectContext** および **ObjectSet** クラスの **ApplyChanges** メソッドを含む拡張クラスが生成されます。</span><span class="sxs-lookup"><span data-stu-id="38d29-115">The **\<model name\>.Context.tt** file generates a derived context and an extension class that contains **ApplyChanges** methods for the **ObjectContext** and **ObjectSet** classes.</span></span> <span data-ttu-id="38d29-116">これらのメソッドは、自己追跡エンティティのグラフに含まれている変更追跡情報を検証して、データベースに変更内容を保存するために実行しなければならない一連の操作を推論します。</span><span class="sxs-lookup"><span data-stu-id="38d29-116">These methods examine the change-tracking information that is contained in the graph of self-tracking entities to infer the set of operations that must be performed to save the changes in the database.</span></span>  

## <a name="get-started"></a><span data-ttu-id="38d29-117">開始するには</span><span class="sxs-lookup"><span data-stu-id="38d29-117">Get Started</span></span>  

<span data-ttu-id="38d29-118">最初に、「[Self-Tracking Entities Walkthrough](xref:ef6/fundamentals/disconnected-entities/self-tracking-entities/walkthrough)」(自己追跡エンティティ チュートリアル) ページを参照してください。</span><span class="sxs-lookup"><span data-stu-id="38d29-118">To get started, visit the [Self-Tracking Entities Walkthrough](xref:ef6/fundamentals/disconnected-entities/self-tracking-entities/walkthrough) page.</span></span>  

## <a name="functional-considerations-when-working-with-self-tracking-entities"></a><span data-ttu-id="38d29-119">自己追跡エンティティの使用に関する機能上の考慮事項</span><span class="sxs-lookup"><span data-stu-id="38d29-119">Functional Considerations When Working with Self-Tracking Entities</span></span>  
> [!IMPORTANT]
> <span data-ttu-id="38d29-120">自己追跡エンティティ テンプレートの使用は現在お勧めしていません。</span><span class="sxs-lookup"><span data-stu-id="38d29-120">We no longer recommend using the self-tracking-entities template.</span></span> <span data-ttu-id="38d29-121">既存のアプリケーションをサポートするためにのみ引き続き使用できます。</span><span class="sxs-lookup"><span data-stu-id="38d29-121">It will only continue to be available to support existing applications.</span></span> <span data-ttu-id="38d29-122">アプリケーションで、エンティティの切断されたグラフを操作する必要がある場合は、代替の方法を検討してください。たとえば、コミュニティによってより積極的に開発された自己追跡エンティティに似たテクノロジである[追跡可能なエンティティ](https://trackableentities.github.io/)を使用するか、または、低レベルの変更追跡 API を使用してカスタム コードを記述してください。</span><span class="sxs-lookup"><span data-stu-id="38d29-122">If your application requires working with disconnected graphs of entities, consider other alternatives such as [Trackable Entities](https://trackableentities.github.io/), which is a technology similar to Self-Tracking-Entities that is more actively developed by the community, or writing custom code using the low-level change tracking APIs.</span></span>

<span data-ttu-id="38d29-123">自己追跡エンティティを使用する際は、次の点に注意してください。</span><span class="sxs-lookup"><span data-stu-id="38d29-123">Consider the following when working with self-tracking entities:</span></span>  

- <span data-ttu-id="38d29-124">エンティティ型を含むアセンブリへの参照がクライアント プロジェクトにあることを確認します。</span><span class="sxs-lookup"><span data-stu-id="38d29-124">Make sure that your client project has a reference to the assembly containing the entity types.</span></span> <span data-ttu-id="38d29-125">クライアント プロジェクトにサービス参照のみ追加する場合、クライアント プロジェクトは実際の自己追跡エンティティ型ではなく WCF プロキシ型を使用します。</span><span class="sxs-lookup"><span data-stu-id="38d29-125">If you add only the service reference to the client project, the client project will use the WCF proxy types and not the actual self-tracking entity types.</span></span> <span data-ttu-id="38d29-126">つまり、クライアントでエンティティの追跡を管理する自動通知機能を取得することはできません。</span><span class="sxs-lookup"><span data-stu-id="38d29-126">This means that you will not get the automated notification features that manage the tracking of the entities on the client.</span></span> <span data-ttu-id="38d29-127">エンティティ型を意図的に含めない場合は、クライアントで変更追跡情報を手動で設定して、変更内容がサービスに送り返されるようにする必要があります。</span><span class="sxs-lookup"><span data-stu-id="38d29-127">If you intentionally do not want to include the entity types, you will have to manually set change-tracking information on the client for the changes to be sent back to the service.</span></span>  
- <span data-ttu-id="38d29-128">サービス操作の呼び出しはステートレスで行い、この呼び出しによってオブジェクト コンテキストの新しいインスタンスを作成する必要があります。</span><span class="sxs-lookup"><span data-stu-id="38d29-128">Calls to the service operation should be stateless and create a new instance of object context.</span></span> <span data-ttu-id="38d29-129">また、ブロックを**使用して**オブジェクト コンテキストを作成することをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="38d29-129">We also recommend that you create object context in a **using** block.</span></span>  
- <span data-ttu-id="38d29-130">クライアントで変更されたグラフをサービスに送信した後、クライアントで同じグラフを引き続き使用する場合は、グラフを手動で反復処理し、各オブジェクトで **AcceptChanges** メソッドを呼び出して変更トラッカーをリセットする必要があります。</span><span class="sxs-lookup"><span data-stu-id="38d29-130">When you send the graph that was modified on the client to the service and then intend to continue working with the same graph on the client, you have to manually iterate through the graph and call the **AcceptChanges** method on each object to reset the change tracker.</span></span>  

    > <span data-ttu-id="38d29-131">データベースによって生成される値 (たとえば、ID やコンカレンシーの値) を持つプロパティがグラフ内のオブジェクトに含まれている場合、**SaveChanges** メソッドが呼び出された後に、それらのプロパティの値をデータベースによって生成される値に置き換えます。</span><span class="sxs-lookup"><span data-stu-id="38d29-131">If objects in your graph contain properties with database-generated values (for example, identity or concurrency values), Entity Framework will replace values of these properties with the database-generated values after the **SaveChanges** method is called.</span></span> <span data-ttu-id="38d29-132">サービス操作を実装して、保存されたオブジェクトまたはオブジェクト用に生成されたプロパティ値の一覧をクライアントに返すことができます。</span><span class="sxs-lookup"><span data-stu-id="38d29-132">You can implement your service operation to return saved objects or a list of generated property values for the objects back to the client.</span></span> <span data-ttu-id="38d29-133">その後で、クライアントはオブジェクト インスタンスまたはオブジェクトのプロパティ値を、サービス操作から返されるオブジェクトまたはプロパティ値に置き換える必要があります。</span><span class="sxs-lookup"><span data-stu-id="38d29-133">The client would then need to replace the object instances or object property values with the objects or property values returned from the service operation.</span></span>  
- <span data-ttu-id="38d29-134">複数のサービス要求からグラフをマージすると、作成されるグラフでオブジェクトのキー値が重複する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="38d29-134">Merging graphs from multiple service requests may introduce objects with duplicate key values in the resulting graph.</span></span> <span data-ttu-id="38d29-135">**ApplyChanges** メソッドを呼び出す場合、Entity Framework では重複キーを持つオブジェクトを削除せず、代わりに例外がスローされます。</span><span class="sxs-lookup"><span data-stu-id="38d29-135">Entity Framework does not remove the objects with duplicate keys when you call the **ApplyChanges** method but instead throws an exception.</span></span> <span data-ttu-id="38d29-136">グラフでキー値が重複しないようにするには、ブログの記事「[自己追跡エンティティ: ApplyChanges および重複するエンティティ](https://go.microsoft.com/fwlink/?LinkID=205119&clcid=0x409)」で説明されているいずれかのパターンに従ってください。</span><span class="sxs-lookup"><span data-stu-id="38d29-136">To avoid having graphs with duplicate key values follow one of the patterns described in the following blog: [Self-Tracking Entities: ApplyChanges and duplicate entities](https://go.microsoft.com/fwlink/?LinkID=205119&clcid=0x409).</span></span>  
- <span data-ttu-id="38d29-137">外部キーのプロパティを設定してオブジェクト間のリレーションシップを変更すると、参照ナビゲーション プロパティは null に設定され、クライアントの適切なプリンシパル エンティティと同期されません。</span><span class="sxs-lookup"><span data-stu-id="38d29-137">When you change the relationship between objects by setting the foreign key property, the reference navigation property is set to null and not synchronized to the appropriate principal entity on the client.</span></span> <span data-ttu-id="38d29-138">グラフがオブジェクト コンテキストにアタッチされた後 (たとえば、**ApplyChanges** メソッドの呼び出し後)、外部キーのプロパティとナビゲーション プロパティが同期されます。</span><span class="sxs-lookup"><span data-stu-id="38d29-138">After the graph is attached to the object context (for example, after you call the **ApplyChanges** method), the foreign key properties and navigation properties are synchronized.</span></span>  

    > <span data-ttu-id="38d29-139">参照ナビゲーション プロパティが適切なプリンシパル オブジェクトと同期されない場合は、外部キーのリレーションシップで連鎖削除を指定していた場合に問題となる可能性があります。</span><span class="sxs-lookup"><span data-stu-id="38d29-139">Not having a reference navigation property synchronized with the appropriate principal object could be an issue if you have specified cascade delete on the foreign key relationship.</span></span> <span data-ttu-id="38d29-140">プリンシパルを削除すると、依存オブジェクトに削除が反映されません。</span><span class="sxs-lookup"><span data-stu-id="38d29-140">If you delete the principal, the delete will not be propagated to the dependent objects.</span></span> <span data-ttu-id="38d29-141">連鎖削除を指定していた場合は、外部キーのプロパティを設定する代わりに、ナビゲーション プロパティを使用してリレーションシップを変更します。</span><span class="sxs-lookup"><span data-stu-id="38d29-141">If you have cascade deletes specified, use navigation properties to change relationships instead of setting the foreign key property.</span></span>  
- <span data-ttu-id="38d29-142">自己追跡エンティティは遅延読み込みを実行できません。</span><span class="sxs-lookup"><span data-stu-id="38d29-142">Self-tracking entities are not enabled to perform lazy loading.</span></span>  
- <span data-ttu-id="38d29-143">バイナリ シリアル化および ASP.NET 状態管理オブジェクトへのシリアル化は自己追跡エンティティによってサポートされていません。</span><span class="sxs-lookup"><span data-stu-id="38d29-143">Binary serialization and serialization to ASP.NET state management objects is not supported by self-tracking entities.</span></span> <span data-ttu-id="38d29-144">ただし、バイナリ シリアル化のサポートを追加するようにテンプレートをカスタマイズできます。</span><span class="sxs-lookup"><span data-stu-id="38d29-144">However, you can customize the template to add the binary serialization support.</span></span> <span data-ttu-id="38d29-145">詳細については、「[自己追跡エンティティでのバイナリ シリアル化および ViewState の使用](https://go.microsoft.com/fwlink/?LinkId=199208)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="38d29-145">For more information, see [Using Binary Serialization and ViewState with Self-Tracking Entities](https://go.microsoft.com/fwlink/?LinkId=199208).</span></span>  

## <a name="security-considerations"></a><span data-ttu-id="38d29-146">セキュリティに関する考慮事項</span><span class="sxs-lookup"><span data-stu-id="38d29-146">Security Considerations</span></span>  

<span data-ttu-id="38d29-147">次のセキュリティに関する考慮事項は、自己追跡エンティティを使用する場合に考慮する必要があります。</span><span class="sxs-lookup"><span data-stu-id="38d29-147">The following security considerations should be taken into account when working with self-tracking entities:</span></span>  

- <span data-ttu-id="38d29-148">サービスは、信頼されていないクライアントからの、または信頼されていないチャネルを経由した、データの取得または更新の要求を信頼しません。</span><span class="sxs-lookup"><span data-stu-id="38d29-148">A service should not trust requests to retrieve or update data from a non-trusted client or through a non-trusted channel.</span></span> <span data-ttu-id="38d29-149">クライアントは認証されている必要があります。また、セキュリティで保護されたチャネルまたはメッセージ エンベロープを使用する必要があります。</span><span class="sxs-lookup"><span data-stu-id="38d29-149">A client must be authenticated: a secure channel or message envelope should be used.</span></span> <span data-ttu-id="38d29-150">クライアントによるデータの取得または更新の要求は、特定のシナリオに対して予想される正当な変更に準拠することを確認するために検証する必要があります。</span><span class="sxs-lookup"><span data-stu-id="38d29-150">Clients' requests to update or retrieve data must be validated to ensure they conform to expected and legitimate changes for the given scenario.</span></span>  
- <span data-ttu-id="38d29-151">機密情報 (社会保障番号など) をエンティティ キーとして使用しないでください。</span><span class="sxs-lookup"><span data-stu-id="38d29-151">Avoid using sensitive information as entity keys (for example, social security numbers).</span></span> <span data-ttu-id="38d29-152">これにより、完全に信頼されていないクライアントに自己追跡エンティティのグラフ内の機密情報が誤ってシリアル化される可能性が低くなります。</span><span class="sxs-lookup"><span data-stu-id="38d29-152">This mitigates the possibility of inadvertently serializing sensitive information in the self-tracking entity graphs to a client that is not fully trusted.</span></span> <span data-ttu-id="38d29-153">独立した関連付けでは、シリアル化される情報に関連するエンティティの元のキーは、クライアントにも送信される可能性があります。</span><span class="sxs-lookup"><span data-stu-id="38d29-153">With independent associations, the original key of an entity that is related to the one that is being serialized might be sent to the client as well.</span></span>  
- <span data-ttu-id="38d29-154">機密データを含む例外メッセージがクライアント層に反映されないように、サーバー層での **ApplyChanges** および **SaveChanges** の呼び出しを例外処理コードにラップする必要があります。</span><span class="sxs-lookup"><span data-stu-id="38d29-154">To avoid propagating exception messages that contain sensitive data to the client tier, calls to **ApplyChanges** and **SaveChanges** on the server tier should be wrapped in exception-handling code.</span></span>  
