---
title: Entity Framework 6 プロバイダーモデル-EF6
description: Entity Framework 6 の Entity Framework 6 プロバイダーモデル
author: divega
ms.date: 06/27/2018
uid: ef6/fundamentals/providers/provider-model
ms.openlocfilehash: 4fc45ba5fe916253be348182196be236729d685d
ms.sourcegitcommit: abda0872f86eefeca191a9a11bfca976bc14468b
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 09/14/2020
ms.locfileid: "90074017"
---
# <a name="the-entity-framework-6-provider-model"></a><span data-ttu-id="da10c-103">Entity Framework 6 プロバイダーモデル</span><span class="sxs-lookup"><span data-stu-id="da10c-103">The Entity Framework 6 provider model</span></span>

<span data-ttu-id="da10c-104">Entity Framework プロバイダーモデルでは、さまざまな種類のデータベースサーバーで Entity Framework を使用できます。</span><span class="sxs-lookup"><span data-stu-id="da10c-104">The Entity Framework provider model allows Entity Framework to be used with different types of database server.</span></span> <span data-ttu-id="da10c-105">たとえば、1つのプロバイダーを接続して Microsoft SQL Server に対して EF を使用できるようにし、別のプロバイダーを接続して Microsoft SQL Server Compact のエディションに対して EF を使用できるようにすることができます。</span><span class="sxs-lookup"><span data-stu-id="da10c-105">For example, one provider can be plugged in to allow EF to be used against Microsoft SQL Server, while another provider can be plugged into to allow EF to be used against Microsoft SQL Server Compact Edition.</span></span> <span data-ttu-id="da10c-106">EF6 のプロバイダーは Entity Framework、[ [プロバイダー](xref:ef6/fundamentals/providers/index) ] ページで確認できます。</span><span class="sxs-lookup"><span data-stu-id="da10c-106">The providers for EF6 that we are aware of can be found on the [Entity Framework providers](xref:ef6/fundamentals/providers/index) page.</span></span>

<span data-ttu-id="da10c-107">EF がプロバイダーと対話してオープンソースライセンスで EF を解放できるようにする方法には、特定の変更が必要でした。</span><span class="sxs-lookup"><span data-stu-id="da10c-107">Certain changes were required to the way EF interacts with providers to allow EF to be released under an open source license.</span></span> <span data-ttu-id="da10c-108">これらの変更には、プロバイダーを登録するための新しいメカニズムと共に、EF6 アセンブリに対して EF プロバイダーを再構築する必要があります。</span><span class="sxs-lookup"><span data-stu-id="da10c-108">These changes require rebuilding of EF providers against the EF6 assemblies together with new mechanisms for registration of the provider.</span></span>

## <a name="rebuilding"></a><span data-ttu-id="da10c-109">再構築</span><span class="sxs-lookup"><span data-stu-id="da10c-109">Rebuilding</span></span>

<span data-ttu-id="da10c-110">EF6 では、以前は .NET Framework の一部であったコアコードは帯域外 (OOB) アセンブリとして出荷されるようになりました。</span><span class="sxs-lookup"><span data-stu-id="da10c-110">With EF6 the core code that was previously part of the .NET Framework is now being shipped as out-of-band (OOB) assemblies.</span></span> <span data-ttu-id="da10c-111">EF6 に対してアプリケーションをビルドする方法の詳細については、 [EF6 用のアプリケーションの更新](xref:ef6/what-is-new/upgrading-to-ef6) に関するページを参照してください。</span><span class="sxs-lookup"><span data-stu-id="da10c-111">Details on how to build applications against EF6 can be found on the [Updating applications for EF6](xref:ef6/what-is-new/upgrading-to-ef6) page.</span></span> <span data-ttu-id="da10c-112">プロバイダーは、次の手順を使用して再構築する必要もあります。</span><span class="sxs-lookup"><span data-stu-id="da10c-112">Providers will also need to be rebuilt using these instructions.</span></span>

## <a name="provider-types-overview"></a><span data-ttu-id="da10c-113">プロバイダーの種類の概要</span><span class="sxs-lookup"><span data-stu-id="da10c-113">Provider types overview</span></span>

<span data-ttu-id="da10c-114">EF プロバイダーは、実際には、これらのサービスが (基底クラスの) から拡張するか、(インターフェイスの) を実装する CLR 型によって定義される、プロバイダー固有のサービスのコレクションです。</span><span class="sxs-lookup"><span data-stu-id="da10c-114">An EF provider is really a collection of provider-specific services defined by CLR types that these services extend from (for a base class) or implement (for an interface).</span></span> <span data-ttu-id="da10c-115">これらのサービスのうち2つは基本的なものであり、EF がまったく機能するために必要です。</span><span class="sxs-lookup"><span data-stu-id="da10c-115">Two of these services are fundamental and necessary for EF to function at all.</span></span> <span data-ttu-id="da10c-116">それ以外は省略可能であり、特定の機能が必要な場合にのみ実装する必要があります。また、対象となる特定のデータベースサーバーでこれらのサービスの既定の実装が機能しない場合は、実装する必要があります。</span><span class="sxs-lookup"><span data-stu-id="da10c-116">Others are optional and only need to be implemented if specific functionality is required and/or the default implementations of these services does not work for the specific database server being targeted.</span></span>

## <a name="fundamental-provider-types"></a><span data-ttu-id="da10c-117">基本的なプロバイダーの種類</span><span class="sxs-lookup"><span data-stu-id="da10c-117">Fundamental provider types</span></span>

### <a name="dbproviderfactory"></a><span data-ttu-id="da10c-118">DbProviderFactory</span><span class="sxs-lookup"><span data-stu-id="da10c-118">DbProviderFactory</span></span>

<span data-ttu-id="da10c-119">EF は、すべての下位レベルのデータベースアクセスを実行するために [DbProviderFactory](https://msdn.microsoft.com/library/system.data.common.dbproviderfactory.aspx) から派生した型を持つかどうかに依存します。</span><span class="sxs-lookup"><span data-stu-id="da10c-119">EF depends on having a type derived from [System.Data.Common.DbProviderFactory](https://msdn.microsoft.com/library/system.data.common.dbproviderfactory.aspx) for performing all low-level database access.</span></span> <span data-ttu-id="da10c-120">DbProviderFactory は実際には EF の一部ではありませんが、代わりに、EF、他の O/RMs、またはアプリケーションが直接使用して、プロバイダーに依存しない方法で接続、コマンド、パラメーター、およびその他の ADO.NET 抽象化のインスタンスを取得することができる ADO.NET プロバイダーのエントリポイントを提供する .NET Framework のクラスです。</span><span class="sxs-lookup"><span data-stu-id="da10c-120">DbProviderFactory is not actually part of EF but is instead a class in the .NET Framework that serves an entry point for ADO.NET providers that can be used by EF, other O/RMs or directly by an application to obtain instances of connections, commands, parameters and other ADO.NET abstractions in a provider agnostic way.</span></span> <span data-ttu-id="da10c-121">DbProviderFactory の詳細については、 [ADO.NET の MSDN ドキュメント](https://msdn.microsoft.com/library/a6cd7c08.aspx)を参照してください。</span><span class="sxs-lookup"><span data-stu-id="da10c-121">More information about DbProviderFactory can be found in the [MSDN documentation for ADO.NET](https://msdn.microsoft.com/library/a6cd7c08.aspx).</span></span>

### <a name="dbproviderservices"></a><span data-ttu-id="da10c-122">DbProviderServices</span><span class="sxs-lookup"><span data-stu-id="da10c-122">DbProviderServices</span></span>

<span data-ttu-id="da10c-123">EF は、ADO.NET プロバイダーによって既に提供されている機能の上に EF が必要とする追加機能を提供するために、DbProviderServices から派生した型を持つかどうかに依存します。</span><span class="sxs-lookup"><span data-stu-id="da10c-123">EF depends on having a type derived from DbProviderServices for providing additional functionality needed by EF on top of the functionality already provided by the ADO.NET provider.</span></span> <span data-ttu-id="da10c-124">以前のバージョンの EF では、DbProviderServices クラスは .NET Framework の一部であり、名前空間にありました。</span><span class="sxs-lookup"><span data-stu-id="da10c-124">In older versions of EF the DbProviderServices class was part of the .NET Framework and was found in the System.Data.Common namespace.</span></span> <span data-ttu-id="da10c-125">EF6 以降では、このクラスは EntityFramework.dll の一部になり、名前空間に含まれるようになりました。</span><span class="sxs-lookup"><span data-stu-id="da10c-125">Starting with EF6 this class is now part of EntityFramework.dll and is in the System.Data.Entity.Core.Common namespace.</span></span>

<span data-ttu-id="da10c-126">DbProviderServices 実装の基本的な機能の詳細については、 [MSDN](https://msdn.microsoft.com/library/ee789835.aspx)を参照してください。</span><span class="sxs-lookup"><span data-stu-id="da10c-126">More details about the fundamental functionality of a DbProviderServices implementation can be found on [MSDN](https://msdn.microsoft.com/library/ee789835.aspx).</span></span> <span data-ttu-id="da10c-127">ただし、この情報を書き込む時点では、ほとんどの概念はまだ有効ですが、EF6 の場合は更新されません。</span><span class="sxs-lookup"><span data-stu-id="da10c-127">However, note that as of the time of writing this information is not updated for EF6 although most of the concepts are still valid.</span></span> <span data-ttu-id="da10c-128">DbProviderServices の SQL Server および SQL Server Compact の実装は、 [オープンソースのコードベース](https://github.com/aspnet/EntityFramework6/) にもチェックインされ、他の実装に役立つ参照として使用できます。</span><span class="sxs-lookup"><span data-stu-id="da10c-128">The SQL Server and SQL Server Compact implementations of DbProviderServices are also checked into to the [open-source codebase](https://github.com/aspnet/EntityFramework6/) and can serve as useful references for other implementations.</span></span>

<span data-ttu-id="da10c-129">以前のバージョンの EF では、使用する DbProviderServices 実装は ADO.NET プロバイダーから直接取得されました。</span><span class="sxs-lookup"><span data-stu-id="da10c-129">In older versions of EF the DbProviderServices implementation to use was obtained directly from an ADO.NET provider.</span></span> <span data-ttu-id="da10c-130">これは、DbProviderFactory を IServiceProvider にキャストし、GetService メソッドを呼び出すことによって行われました。</span><span class="sxs-lookup"><span data-stu-id="da10c-130">This was done by casting DbProviderFactory to IServiceProvider and calling the GetService method.</span></span> <span data-ttu-id="da10c-131">これにより、EF プロバイダーと DbProviderFactory が密に結合されています。</span><span class="sxs-lookup"><span data-stu-id="da10c-131">This tightly coupled the EF provider to the DbProviderFactory.</span></span> <span data-ttu-id="da10c-132">この結合によって、EF は .NET Framework から除外されるようになりました。したがって、EF6 では、この密結合が削除され、DbProviderServices の実装がアプリケーションの構成ファイルまたはコードベースの構成に直接登録されました。詳細については、 _DbProviderServices の登録_ に関するセクションを参照してください。</span><span class="sxs-lookup"><span data-stu-id="da10c-132">This coupling blocked EF from being moved out of the .NET Framework and therefore for EF6 this tight coupling has been removed and an implementation of DbProviderServices is now registered directly in the application’s configuration file or in code-based configuration as described in more detail the _Registering DbProviderServices_ section below.</span></span>

## <a name="additional-services"></a><span data-ttu-id="da10c-133">その他のサービス</span><span class="sxs-lookup"><span data-stu-id="da10c-133">Additional services</span></span>

<span data-ttu-id="da10c-134">上で説明した基本的なサービスに加えて、EF によって使用される他の多くのサービスも、常に、またはプロバイダー固有のものです。</span><span class="sxs-lookup"><span data-stu-id="da10c-134">In addition to the fundamental services described above there are also many other services used by EF which are either always or sometimes provider-specific.</span></span> <span data-ttu-id="da10c-135">これらのサービスの既定のプロバイダー固有の実装は、DbProviderServices 実装によって提供できます。</span><span class="sxs-lookup"><span data-stu-id="da10c-135">Default provider-specific implementations of these services can be supplied by a DbProviderServices implementation.</span></span> <span data-ttu-id="da10c-136">アプリケーションでは、これらのサービスの実装をオーバーライドしたり、DbProviderServices 型が既定値を提供しない場合の実装を提供したりすることもできます。</span><span class="sxs-lookup"><span data-stu-id="da10c-136">Applications can also override the implementations of these services, or provide implementations when a DbProviderServices type does not provide a default.</span></span> <span data-ttu-id="da10c-137">詳細については、後述する「その _他のサービスの解決_ 」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="da10c-137">This is described in more detail in the _Resolving additional services_ section below.</span></span>

<span data-ttu-id="da10c-138">プロバイダーが関心を持つ可能性のある追加のサービスの種類を以下に示します。</span><span class="sxs-lookup"><span data-stu-id="da10c-138">The additional service types that a provider may be of interest to a provider are listed below.</span></span> <span data-ttu-id="da10c-139">これらのサービスの種類の詳細については、API のドキュメントを参照してください。</span><span class="sxs-lookup"><span data-stu-id="da10c-139">More details about each of these service types can be found in the API documentation.</span></span>

### <a name="idbexecutionstrategy"></a><span data-ttu-id="da10c-140">IDbExecutionStrategy</span><span class="sxs-lookup"><span data-stu-id="da10c-140">IDbExecutionStrategy</span></span>

<span data-ttu-id="da10c-141">これは、プロバイダーがデータベースに対してクエリやコマンドを実行するときに再試行などの動作を実装できるようにするオプションのサービスです。</span><span class="sxs-lookup"><span data-stu-id="da10c-141">This is an optional service that allows a provider to implement retries or other behavior when queries and commands are executed against the database.</span></span> <span data-ttu-id="da10c-142">実装が指定されていない場合、EF は単にコマンドを実行し、スローされた例外をすべて伝達します。</span><span class="sxs-lookup"><span data-stu-id="da10c-142">If no implementation is provided, then EF will simply execute the commands and propagate any exceptions thrown.</span></span> <span data-ttu-id="da10c-143">SQL Server は、このサービスを使用して再試行ポリシーを提供します。これは、SQL Azure などのクラウドベースのデータベースサーバーに対して実行する場合に特に便利です。</span><span class="sxs-lookup"><span data-stu-id="da10c-143">For SQL Server this service is used to provide a retry policy which is especially useful when running against cloud-based database servers such as SQL Azure.</span></span>

### <a name="idbconnectionfactory"></a><span data-ttu-id="da10c-144">IDbConnectionFactory</span><span class="sxs-lookup"><span data-stu-id="da10c-144">IDbConnectionFactory</span></span>

<span data-ttu-id="da10c-145">これは、プロバイダーがデータベース名だけを指定した場合に規約によって DbConnection オブジェクトを作成できるようにするオプションのサービスです。</span><span class="sxs-lookup"><span data-stu-id="da10c-145">This is an optional service that allows a provider to create DbConnection objects by convention when given only a database name.</span></span> <span data-ttu-id="da10c-146">このサービスは、DbProviderServices 実装によって解決される場合がありますが、EF 4.1 以降に存在しています。また、構成ファイルまたはコードで明示的に設定することもできます。</span><span class="sxs-lookup"><span data-stu-id="da10c-146">Note that while this service can be resolved by a DbProviderServices implementation it has been present since EF 4.1 and can also be explicitly set in either the config file or in code.</span></span> <span data-ttu-id="da10c-147">プロバイダーは、既定のプロバイダーとして登録されている場合にのみ、このサービスを解決できるようになります (以下 _の既定のプロバイダー_ を参照してください)。既定の接続ファクトリが別の場所に設定されていない場合は、</span><span class="sxs-lookup"><span data-stu-id="da10c-147">The provider will only get a chance to resolve this service if it registered as the default provider (see _The default provider_ below) and if a default connection factory has not been set elsewhere.</span></span>

### <a name="dbspatialservices"></a><span data-ttu-id="da10c-148">DbSpatialServices</span><span class="sxs-lookup"><span data-stu-id="da10c-148">DbSpatialServices</span></span>

<span data-ttu-id="da10c-149">これは、プロバイダーが geography および geometry 空間型のサポートを追加できるようにするオプションのサービスです。</span><span class="sxs-lookup"><span data-stu-id="da10c-149">This is an optional services that allows a provider to add support for geography and geometry spatial types.</span></span> <span data-ttu-id="da10c-150">アプリケーションで空間型の EF を使用するには、このサービスの実装を指定する必要があります。</span><span class="sxs-lookup"><span data-stu-id="da10c-150">An implementation of this service must be supplied in order for an application to use EF with spatial types.</span></span> <span data-ttu-id="da10c-151">DbSptialServices は2つの方法で要求されます。</span><span class="sxs-lookup"><span data-stu-id="da10c-151">DbSptialServices is asked for in two ways.</span></span> <span data-ttu-id="da10c-152">最初に、キーとして DbProviderInfo オブジェクト (不変名とマニフェストトークンを含む) を使用して、プロバイダー固有の空間サービスを要求します。</span><span class="sxs-lookup"><span data-stu-id="da10c-152">First, provider-specific spatial services are requested using a DbProviderInfo object (which contains invariant name and manifest token) as key.</span></span> <span data-ttu-id="da10c-153">2つ目は、キーなしで DbSpatialServices を要求できることです。</span><span class="sxs-lookup"><span data-stu-id="da10c-153">Second, DbSpatialServices can be asked for with no key.</span></span> <span data-ttu-id="da10c-154">これは、スタンドアロンの DbGeography 型または Dbgeography 型を作成するときに使用される "グローバル空間プロバイダー" を解決するために使用されます。</span><span class="sxs-lookup"><span data-stu-id="da10c-154">This is used to resolve the “global spatial provider” that is used when creating stand-alone DbGeography or DbGeometry types.</span></span>

### <a name="migrationsqlgenerator"></a><span data-ttu-id="da10c-155">MigrationSqlGenerator</span><span class="sxs-lookup"><span data-stu-id="da10c-155">MigrationSqlGenerator</span></span>

<span data-ttu-id="da10c-156">これは、Code First によってデータベーススキーマを作成および変更する際に使用される SQL の生成に EF の移行を使用できるようにするオプションのサービスです。</span><span class="sxs-lookup"><span data-stu-id="da10c-156">This is an optional service that allows EF Migrations to be used for the generation of SQL used in creating and modifying database schemas by Code First.</span></span> <span data-ttu-id="da10c-157">移行をサポートするためには、の実装が必要です。</span><span class="sxs-lookup"><span data-stu-id="da10c-157">An implementation is required in order to support Migrations.</span></span> <span data-ttu-id="da10c-158">実装が指定されている場合は、データベース初期化子またはデータベースの Create メソッドを使用してデータベースを作成するときにも使用されます。</span><span class="sxs-lookup"><span data-stu-id="da10c-158">If an implementation is provided then it will also be used when databases are created using database initializers or the Database.Create method.</span></span>

### <a name="funcdbconnection-string-historycontextfactory"></a><span data-ttu-id="da10c-159">Func<DbConnection、string、History Contextfactory></span><span class="sxs-lookup"><span data-stu-id="da10c-159">Func<DbConnection, string, HistoryContextFactory></span></span>

<span data-ttu-id="da10c-160">これは、プロバイダーが、 `__MigrationHistory` EF の移行で使用されるテーブルへの履歴コンテキストのマッピングを構成できるようにするオプションのサービスです。</span><span class="sxs-lookup"><span data-stu-id="da10c-160">This is an optional service that allows a provider to configure the mapping of the HistoryContext to the `__MigrationHistory` table used by EF Migrations.</span></span> <span data-ttu-id="da10c-161">履歴コンテキストは Code First DbContext であり、テーブルの名前や列マッピングの仕様などを変更するために通常の fluent API を使用して構成できます。</span><span class="sxs-lookup"><span data-stu-id="da10c-161">The HistoryContext is a Code First DbContext and can be configured using the normal fluent API to change things like the name of the table and the column mapping specifications.</span></span> <span data-ttu-id="da10c-162">すべての既定のテーブルと列のマッピングがそのプロバイダーでサポートされている場合、すべてのプロバイダーに対して EF によって返されたこのサービスの既定の実装は、特定のデータベースサーバーで機能する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="da10c-162">The default implementation of this service returned by EF for all providers may work for a given database server if all the default table and column mappings are supported by that provider.</span></span> <span data-ttu-id="da10c-163">このような場合、プロバイダーはこのサービスの実装を提供する必要はありません。</span><span class="sxs-lookup"><span data-stu-id="da10c-163">In such a case the provider does not need to supply an implementation of this service.</span></span>

### <a name="idbproviderfactoryresolver"></a><span data-ttu-id="da10c-164">IDbProviderFactoryResolver</span><span class="sxs-lookup"><span data-stu-id="da10c-164">IDbProviderFactoryResolver</span></span>

<span data-ttu-id="da10c-165">これは、指定された DbConnection オブジェクトから正しい DbProviderFactory を取得するためのオプションのサービスです。</span><span class="sxs-lookup"><span data-stu-id="da10c-165">This is an optional service for obtaining the correct DbProviderFactory from a given DbConnection object.</span></span> <span data-ttu-id="da10c-166">すべてのプロバイダーに対して EF によって返されたこのサービスの既定の実装は、すべてのプロバイダーに対して機能することを目的としています。</span><span class="sxs-lookup"><span data-stu-id="da10c-166">The default implementation of this service returned by EF for all providers is intended to work for all providers.</span></span> <span data-ttu-id="da10c-167">ただし、.NET 4 で実行されている場合、DbProviderFactory には、DbConnections によってパブリックにアクセスすることはできません。</span><span class="sxs-lookup"><span data-stu-id="da10c-167">However, when running on .NET 4, the DbProviderFactory is not publicly accessible from one if its DbConnections.</span></span> <span data-ttu-id="da10c-168">そのため、EF はいくつかのヒューリスティックを使用して、登録されたプロバイダーを検索し、一致するものを検索します。</span><span class="sxs-lookup"><span data-stu-id="da10c-168">Therefore, EF uses some heuristics to search the registered providers to find a match.</span></span> <span data-ttu-id="da10c-169">一部のプロバイダーでは、これらのヒューリスティックが失敗し、そのような状況ではプロバイダーが新しい実装を提供する必要があります。</span><span class="sxs-lookup"><span data-stu-id="da10c-169">It is possible that for some providers these heuristics will fail and in such situations the provider should supply a new implementation.</span></span>

## <a name="registering-dbproviderservices"></a><span data-ttu-id="da10c-170">DbProviderServices を登録しています</span><span class="sxs-lookup"><span data-stu-id="da10c-170">Registering DbProviderServices</span></span>

<span data-ttu-id="da10c-171">使用する DbProviderServices 実装は、アプリケーションの構成ファイル (app.config または web.config) で、またはコードベースの構成を使用して登録できます。</span><span class="sxs-lookup"><span data-stu-id="da10c-171">The DbProviderServices implementation to use can be registered either in the application’s configuration file (app.config or web.config) or using code-based configuration.</span></span> <span data-ttu-id="da10c-172">どちらの場合も、登録ではプロバイダーの "不変名" がキーとして使用されます。</span><span class="sxs-lookup"><span data-stu-id="da10c-172">In either case the registration uses the provider’s “invariant name” as a key.</span></span> <span data-ttu-id="da10c-173">これにより、複数のプロバイダーを1つのアプリケーションで登録して使用することができます。</span><span class="sxs-lookup"><span data-stu-id="da10c-173">This allows multiple providers to be registered and used in a single application.</span></span> <span data-ttu-id="da10c-174">EF の登録に使用される不変名は、ADO.NET プロバイダーの登録と接続文字列に使用される不変名と同じです。</span><span class="sxs-lookup"><span data-stu-id="da10c-174">The invariant name used for EF registrations is the same as the invariant name used for ADO.NET provider registration and connection strings.</span></span> <span data-ttu-id="da10c-175">たとえば、SQL Server では、不変名 "system.string" が使用されます。</span><span class="sxs-lookup"><span data-stu-id="da10c-175">For example, for SQL Server the invariant name “System.Data.SqlClient” is used.</span></span>

### <a name="config-file-registration"></a><span data-ttu-id="da10c-176">構成ファイルの登録</span><span class="sxs-lookup"><span data-stu-id="da10c-176">Config file registration</span></span>

<span data-ttu-id="da10c-177">使用する DbProviderServices 型は、アプリケーションの構成ファイルの entityFramework セクションのプロバイダーの一覧にプロバイダー要素として登録されます。</span><span class="sxs-lookup"><span data-stu-id="da10c-177">The DbProviderServices type to use is registered as a provider element in the providers list of the entityFramework section of the application’s config file.</span></span> <span data-ttu-id="da10c-178">次に例を示します。</span><span class="sxs-lookup"><span data-stu-id="da10c-178">For example:</span></span>

``` xml
<entityFramework>
  <providers>
    <provider invariantName="My.Invariant.Name" type="MyProvider.MyProviderServices, MyAssembly" />
  </providers>
</entityFramework>
```

<span data-ttu-id="da10c-179">_型_の文字列は、使用する DbProviderServices 実装のアセンブリ修飾型名である必要があります。</span><span class="sxs-lookup"><span data-stu-id="da10c-179">The _type_ string must be the assembly-qualified type name of the DbProviderServices implementation to use.</span></span>

### <a name="code-based-registration"></a><span data-ttu-id="da10c-180">コード ベースの登録</span><span class="sxs-lookup"><span data-stu-id="da10c-180">Code-based registration</span></span>

<span data-ttu-id="da10c-181">EF6 プロバイダー以降では、コードを使用して登録することもできます。</span><span class="sxs-lookup"><span data-stu-id="da10c-181">Starting with EF6 providers can also be registered using code.</span></span> <span data-ttu-id="da10c-182">これにより、アプリケーションの構成ファイルを変更することなく、EF プロバイダーを使用できるようになります。</span><span class="sxs-lookup"><span data-stu-id="da10c-182">This allows an EF provider to be used without any change to the application’s configuration file.</span></span> <span data-ttu-id="da10c-183">コードベースの構成を使用するには、 [コードベースの構成のドキュメント](https://msdn.com/data/jj680699)で説明されているように、アプリケーションで dbconfiguration クラスを作成する必要があります。</span><span class="sxs-lookup"><span data-stu-id="da10c-183">To use code-based configuration an application should create a DbConfiguration class as described in the [code-based configuration documentation](https://msdn.com/data/jj680699).</span></span> <span data-ttu-id="da10c-184">DbConfiguration クラスのコンストラクターは、SetProviderServices を呼び出して EF プロバイダーを登録する必要があります。</span><span class="sxs-lookup"><span data-stu-id="da10c-184">The constructor of the DbConfiguration class should then call SetProviderServices to register the EF provider.</span></span> <span data-ttu-id="da10c-185">次に例を示します。</span><span class="sxs-lookup"><span data-stu-id="da10c-185">For example:</span></span>

``` csharp
public class MyConfiguration : DbConfiguration
{
    public MyConfiguration()
    {
        SetProviderServices("My.New.Provider", new MyProviderServices());
    }
}
```

## <a name="resolving-additional-services"></a><span data-ttu-id="da10c-186">その他のサービスの解決</span><span class="sxs-lookup"><span data-stu-id="da10c-186">Resolving additional services</span></span>

<span data-ttu-id="da10c-187">「プロバイダーの種類の _概要_ 」セクションで前述したように、DbProviderServices クラスを使用して追加のサービスを解決することもできます。</span><span class="sxs-lookup"><span data-stu-id="da10c-187">As mentioned above in the _Provider types overview_ section, a DbProviderServices class can also be used to resolve additional services.</span></span> <span data-ttu-id="da10c-188">DbProviderServices が IDbDependencyResolver を実装し、登録されている各 DbProviderServices 型が "既定の競合回避モジュール" として追加されるため、これが可能です。</span><span class="sxs-lookup"><span data-stu-id="da10c-188">This is possible because DbProviderServices implements IDbDependencyResolver and each registered DbProviderServices type is added as a “default resolver”.</span></span> <span data-ttu-id="da10c-189">IDbDpendencyResolver メカニズムの詳細については、「 [依存関係の解決](xref:ef6/fundamentals/configuring/dependency-resolution)」を参照してください。</span><span class="sxs-lookup"><span data-stu-id="da10c-189">The IDbDpendencyResolver mechanism is described in more detail in [Dependency Resolution](xref:ef6/fundamentals/configuring/dependency-resolution).</span></span> <span data-ttu-id="da10c-190">ただし、プロバイダーのその他のサービスを解決するために、この仕様のすべての概念を理解する必要はありません。</span><span class="sxs-lookup"><span data-stu-id="da10c-190">However, it is not necessary to understand all the concepts in this specification to resolve additional services in a provider.</span></span>

<span data-ttu-id="da10c-191">プロバイダーが追加のサービスを解決するための最も一般的な方法は、DbProviderServices クラスのコンストラクター内の各サービスに対して DbProviderServices を呼び出すことです。</span><span class="sxs-lookup"><span data-stu-id="da10c-191">The most common way for a provider to resolve additional services is to call DbProviderServices.AddDependencyResolver for each service in the constructor of the DbProviderServices class.</span></span> <span data-ttu-id="da10c-192">たとえば、SqlProviderServices (SQL Server 用の EF プロバイダー) では、初期化のために次のようなコードが使用されます。</span><span class="sxs-lookup"><span data-stu-id="da10c-192">For example, SqlProviderServices (the EF provider for SQL Server) has code similar to this for initialization:</span></span>

``` csharp
private SqlProviderServices()
{
    AddDependencyResolver(new SingletonDependencyResolver<IDbConnectionFactory>(
        new SqlConnectionFactory()));

    AddDependencyResolver(new ExecutionStrategyResolver<DefaultSqlExecutionStrategy>(
        "System.data.SqlClient", null, () => new DefaultSqlExecutionStrategy()));

    AddDependencyResolver(new SingletonDependencyResolver<Func<MigrationSqlGenerator>>(
        () => new SqlServerMigrationSqlGenerator(), "System.data.SqlClient"));

    AddDependencyResolver(new SingletonDependencyResolver<DbSpatialServices>(
        SqlSpatialServices.Instance,
        k =>
        {
            var asSpatialKey = k as DbProviderInfo;
            return asSpatialKey == null
                || asSpatialKey.ProviderInvariantName == ProviderInvariantName;
        }));
}
```

<span data-ttu-id="da10c-193">このコンストラクターは、次のヘルパークラスを使用します。</span><span class="sxs-lookup"><span data-stu-id="da10c-193">This constructor uses the following helper classes:</span></span>

*   <span data-ttu-id="da10c-194">SingletonDependencyResolver: シングルトンサービス、つまり、GetService が呼び出されるたびに同じインスタンスが返されるサービスを解決するための簡単な方法を提供します。</span><span class="sxs-lookup"><span data-stu-id="da10c-194">SingletonDependencyResolver: provides a simple way to resolve Singleton services—that is, services for which the same instance is returned each time that GetService is called.</span></span> <span data-ttu-id="da10c-195">一時的なサービスは、必要に応じて一時的なインスタンスを作成するために使用されるシングルトンファクトリとして登録されることがよくあります。</span><span class="sxs-lookup"><span data-stu-id="da10c-195">Transient services are often registered as a singleton factory that will be used to create transient instances on demand.</span></span>
*   <span data-ttu-id="da10c-196">ExecutionStrategyResolver: IExecutionStrategy 実装を返すための競合回避モジュール。</span><span class="sxs-lookup"><span data-stu-id="da10c-196">ExecutionStrategyResolver: a resolver specific to returning IExecutionStrategy implementations.</span></span>

<span data-ttu-id="da10c-197">DbProviderServices を使用する代わりに、DbProviderServices GetService をオーバーライドし、追加のサービスを直接解決することもできます。</span><span class="sxs-lookup"><span data-stu-id="da10c-197">Instead of using DbProviderServices.AddDependencyResolver it is also possible to override DbProviderServices.GetService and resolve additional services directly.</span></span> <span data-ttu-id="da10c-198">このメソッドは、EF が特定の型で定義されたサービス (場合によっては特定のキー) を必要とするときに呼び出されます。</span><span class="sxs-lookup"><span data-stu-id="da10c-198">This method will be called when EF needs a service defined by a certain type and, in some cases, for a given key.</span></span> <span data-ttu-id="da10c-199">このメソッドは、可能であればサービスを返すか、または null を返してサービスを返し、別のクラスで解決することを許可する必要があります。</span><span class="sxs-lookup"><span data-stu-id="da10c-199">The method should return the service if it can, or return null to opt-out of returning the service and instead allow another class to resolve it.</span></span> <span data-ttu-id="da10c-200">たとえば、既定の接続ファクトリを解決するには、GetService のコードが次のようになります。</span><span class="sxs-lookup"><span data-stu-id="da10c-200">For example, to resolve the default connection factory the code in GetService might look something like this:</span></span>

``` csharp
public override object GetService(Type type, object key)
{
    if (type == typeof(IDbConnectionFactory))
    {
        return new SqlConnectionFactory();
    }
    return null;
}
```

### <a name="registration-order"></a><span data-ttu-id="da10c-201">登録順序</span><span class="sxs-lookup"><span data-stu-id="da10c-201">Registration order</span></span>

<span data-ttu-id="da10c-202">アプリケーションの構成ファイルに複数の DbProviderServices 実装が登録されている場合は、一覧に示されている順序でセカンダリリゾルバーとして追加されます。</span><span class="sxs-lookup"><span data-stu-id="da10c-202">When multiple DbProviderServices implementations are registered in an application’s config file they will be added as secondary resolvers in the order that they are listed.</span></span> <span data-ttu-id="da10c-203">リゾルバーは常にセカンダリリゾルバーチェーンの最上位に追加されるため、一覧の最後にあるプロバイダーは、他の依存関係を解決する機会を得ることになります。</span><span class="sxs-lookup"><span data-stu-id="da10c-203">Since resolvers are always added to the top of the secondary resolver chain this means that the provider at the end of the list will get a chance to resolve dependencies before the others.</span></span> <span data-ttu-id="da10c-204">(この方法は、最初は少し直感的にわかりにくいかもしれませんが、一覧から各プロバイダーを取得し、既存のプロバイダーの上に積み重ねることを想像する場合は意味があります)。</span><span class="sxs-lookup"><span data-stu-id="da10c-204">(This can seem a little counter-intuitive at first, but it makes sense if you imagine taking each provider out of the list and stacking it on top of the existing providers.)</span></span>

<span data-ttu-id="da10c-205">ほとんどのプロバイダーサービスはプロバイダー固有であり、プロバイダーの不変名によってキーが指定されているため、この順序付けは通常は問題になりません。</span><span class="sxs-lookup"><span data-stu-id="da10c-205">This ordering usually doesn’t matter because most provider services are provider-specific and keyed by provider invariant name.</span></span> <span data-ttu-id="da10c-206">ただし、プロバイダーの不変名またはその他のプロバイダー固有のキーでキー付けされていないサービスでは、この順序に基づいてサービスが解決されます。</span><span class="sxs-lookup"><span data-stu-id="da10c-206">However, for services that are not keyed by provider invariant name or some other provider-specific key the service will be resolved based on this ordering.</span></span> <span data-ttu-id="da10c-207">たとえば、別の場所で明示的に設定されていない場合、既定の接続ファクトリはチェーン内の最上位のプロバイダーから取得されます。</span><span class="sxs-lookup"><span data-stu-id="da10c-207">For example, if it is not explicitly set differently somewhere else, then the default connection factory will come from the topmost provider in the chain.</span></span>

## <a name="additional-config-file-registrations"></a><span data-ttu-id="da10c-208">追加の構成ファイルの登録</span><span class="sxs-lookup"><span data-stu-id="da10c-208">Additional config file registrations</span></span>

<span data-ttu-id="da10c-209">上記で説明した追加のプロバイダーサービスの一部は、アプリケーションの構成ファイルに明示的に登録することができます。</span><span class="sxs-lookup"><span data-stu-id="da10c-209">It is possible to explicitly register some of the additional provider services described above directly in an application’s config file.</span></span> <span data-ttu-id="da10c-210">この操作を実行すると、DbProviderServices 実装の GetService メソッドによって返されるものの代わりに、構成ファイルでの登録が使用されます。</span><span class="sxs-lookup"><span data-stu-id="da10c-210">When this is done the registration in the config file will be used instead of anything returned by the GetService method of the DbProviderServices implementation.</span></span>

### <a name="registering-the-default-connection-factory"></a><span data-ttu-id="da10c-211">既定の接続ファクトリを登録しています</span><span class="sxs-lookup"><span data-stu-id="da10c-211">Registering the default connection factory</span></span>

<span data-ttu-id="da10c-212">EF5 以降では、EntityFramework NuGet パッケージによって、SQL Express 接続ファクトリまたは LocalDb 接続ファクトリが構成ファイルに自動的に登録されます。</span><span class="sxs-lookup"><span data-stu-id="da10c-212">Starting with EF5 the EntityFramework NuGet package automatically registered either the SQL Express connection factory or the LocalDb connection factory in the config file.</span></span>

<span data-ttu-id="da10c-213">次に例を示します。</span><span class="sxs-lookup"><span data-stu-id="da10c-213">For example:</span></span>

``` xml
<entityFramework>
  <defaultConnectionFactory type="System.Data.Entity.Infrastructure.SqlConnectionFactory, EntityFramework" >
</entityFramework>
```

<span data-ttu-id="da10c-214">この _型_ は、既定の接続ファクトリのアセンブリ修飾型名であり、IDbConnectionFactory を実装する必要があります。</span><span class="sxs-lookup"><span data-stu-id="da10c-214">The _type_ is the assembly-qualified type name for the default connection factory, which must implement IDbConnectionFactory.</span></span>

<span data-ttu-id="da10c-215">プロバイダーの NuGet パッケージをインストールするときに、この方法で既定の接続ファクトリを設定することをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="da10c-215">It is recommended that a provider NuGet package set the default connection factory in this way when installed.</span></span> <span data-ttu-id="da10c-216">以下 _のプロバイダーの NuGet パッケージを_ 参照してください。</span><span class="sxs-lookup"><span data-stu-id="da10c-216">See _NuGet Packages for providers_ below.</span></span>

## <a name="additional-ef6-provider-changes"></a><span data-ttu-id="da10c-217">その他の EF6 プロバイダーの変更</span><span class="sxs-lookup"><span data-stu-id="da10c-217">Additional EF6 provider changes</span></span>

### <a name="spatial-provider-changes"></a><span data-ttu-id="da10c-218">空間プロバイダーの変更</span><span class="sxs-lookup"><span data-stu-id="da10c-218">Spatial provider changes</span></span>

<span data-ttu-id="da10c-219">空間型をサポートするプロバイダーは、DbSpatialDataReader から派生したクラスにいくつかの追加のメソッドを実装する必要があります。</span><span class="sxs-lookup"><span data-stu-id="da10c-219">Providers that support spatial types must now implement some additional methods on classes deriving from DbSpatialDataReader:</span></span>

*   `public abstract bool IsGeographyColumn(int ordinal)`
*   `public abstract bool IsGeometryColumn(int ordinal)`

<span data-ttu-id="da10c-220">また、同期メソッドへの既定の実装デリゲートとしてオーバーライドすることをお勧めする既存のメソッドの新しい非同期バージョンもあります。したがって、非同期的に実行することはできません。</span><span class="sxs-lookup"><span data-stu-id="da10c-220">There are also new asynchronous versions of existing methods that are recommended to be overridden as the default implementations delegate to the synchronous methods and therefore do not execute asynchronously:</span></span>

*   `public virtual Task<DbGeography> GetGeographyAsync(int ordinal, CancellationToken cancellationToken)`
*   `public virtual Task<DbGeometry> GetGeometryAsync(int ordinal, CancellationToken cancellationToken)`

### <a name="native-support-for-enumerablecontains"></a><span data-ttu-id="da10c-221">列挙可能なネイティブサポート。 Contains</span><span class="sxs-lookup"><span data-stu-id="da10c-221">Native support for Enumerable.Contains</span></span>

<span data-ttu-id="da10c-222">EF6 には、列挙型の使用に関するパフォーマンスの問題に対処するために追加された新しい式の種類 DbInExpression が導入されています。は LINQ クエリ内に含まれています。</span><span class="sxs-lookup"><span data-stu-id="da10c-222">EF6 introduces a new expression type, DbInExpression, which was added to address performance issues around use of Enumerable.Contains in LINQ queries.</span></span> <span data-ttu-id="da10c-223">DbProviderManifest クラスには、新しい仮想メソッドである SupportsInExpression があります。これは、プロバイダーが新しい式の型を処理するかどうかを判断するために EF によって呼び出されます。</span><span class="sxs-lookup"><span data-stu-id="da10c-223">The DbProviderManifest class has a new virtual method, SupportsInExpression, which is called by EF to determine if a provider handles the new expression type.</span></span> <span data-ttu-id="da10c-224">既存のプロバイダー実装との互換性のために、メソッドは false を返します。</span><span class="sxs-lookup"><span data-stu-id="da10c-224">For compatibility with existing provider implementations the method returns false.</span></span> <span data-ttu-id="da10c-225">この改善点を活用するために、EF6 プロバイダーは DbInExpression を処理するコードを追加し、SupportsInExpression をオーバーライドして true を返すことができます。</span><span class="sxs-lookup"><span data-stu-id="da10c-225">To benefit from this improvement, an EF6 provider can add code to handle DbInExpression and override SupportsInExpression to return true.</span></span> <span data-ttu-id="da10c-226">DbInExpression のインスタンスは、DbExpressionBuilder.In メソッドを呼び出すことによって作成できます。</span><span class="sxs-lookup"><span data-stu-id="da10c-226">An instance of DbInExpression can be created by calling the DbExpressionBuilder.In method.</span></span> <span data-ttu-id="da10c-227">DbInExpression インスタンスは、通常テーブル列を表す DbExpression と、一致するかをテストするための DbConstantExpression のリストで構成されます。</span><span class="sxs-lookup"><span data-stu-id="da10c-227">A DbInExpression instance is composed of a DbExpression, usually representing a table column, and a list of DbConstantExpression to test for a match.</span></span>

## <a name="nuget-packages-for-providers"></a><span data-ttu-id="da10c-228">プロバイダーの NuGet パッケージ</span><span class="sxs-lookup"><span data-stu-id="da10c-228">NuGet packages for providers</span></span>

<span data-ttu-id="da10c-229">EF6 プロバイダーを利用できるようにする方法の1つは、NuGet パッケージとしてリリースすることです。</span><span class="sxs-lookup"><span data-stu-id="da10c-229">One way to make an EF6 provider available is to release it as a NuGet package.</span></span> <span data-ttu-id="da10c-230">NuGet パッケージを使用すると、次のような利点があります。</span><span class="sxs-lookup"><span data-stu-id="da10c-230">Using a NuGet package has the following advantages:</span></span>

*   <span data-ttu-id="da10c-231">NuGet を使用すると、プロバイダーの登録をアプリケーションの構成ファイルに簡単に追加できます。</span><span class="sxs-lookup"><span data-stu-id="da10c-231">It is easy to use NuGet to add the provider registration to the application’s config file</span></span>
*   <span data-ttu-id="da10c-232">規則によって行われる接続が登録済みのプロバイダーを使用するように、構成ファイルに追加の変更を加えて、既定の接続ファクトリを設定することができます。</span><span class="sxs-lookup"><span data-stu-id="da10c-232">Additional changes can be made to the config file to set the default connection factory so that connections made by convention will use the registered provider</span></span>
*   <span data-ttu-id="da10c-233">新しい EF パッケージがリリースされた後も EF6 プロバイダーが引き続き機能するように、NuGet はバインドリダイレクトの追加を処理します。</span><span class="sxs-lookup"><span data-stu-id="da10c-233">NuGet handles adding binding redirects so that the EF6 provider should continue to work even after a new EF package is released</span></span>

<span data-ttu-id="da10c-234">この例として、 [オープンソースのコードベース](https://github.com/aspnet/entityframework6)に含まれている entityframework パッケージがあります。</span><span class="sxs-lookup"><span data-stu-id="da10c-234">An example of this is the EntityFramework.SqlServerCompact package which is included in the [open source codebase](https://github.com/aspnet/entityframework6).</span></span> <span data-ttu-id="da10c-235">このパッケージには、EF プロバイダーの NuGet パッケージを作成するための適切なテンプレートが用意されています。</span><span class="sxs-lookup"><span data-stu-id="da10c-235">This package provides a good template for creating EF provider NuGet packages.</span></span>

### <a name="powershell-commands"></a><span data-ttu-id="da10c-236">PowerShell コマンド</span><span class="sxs-lookup"><span data-stu-id="da10c-236">PowerShell commands</span></span>

<span data-ttu-id="da10c-237">EntityFramework NuGet パッケージをインストールすると、プロバイダーパッケージに非常に便利な2つのコマンドを含む PowerShell モジュールが登録されます。</span><span class="sxs-lookup"><span data-stu-id="da10c-237">When the EntityFramework NuGet package is installed it registers a PowerShell module that contains two commands that are very useful for provider packages:</span></span>

*   <span data-ttu-id="da10c-238">[追加] を使用すると、ターゲットプロジェクトの構成ファイルにプロバイダーの新しいエンティティが追加され、登録されているプロバイダーの一覧の末尾にあることが確認されます。</span><span class="sxs-lookup"><span data-stu-id="da10c-238">Add-EFProvider adds a new entity for the provider in the target project’s configuration file and makes sure it is at the end of the list of registered providers.</span></span>
*   <span data-ttu-id="da10c-239">追加-EFDefaultConnectionFactory は、ターゲットプロジェクトの構成ファイルで defaultConnectionFactory の登録を追加または更新します。</span><span class="sxs-lookup"><span data-stu-id="da10c-239">Add-EFDefaultConnectionFactory either adds or updates the defaultConnectionFactory registration in the target project’s configuration file.</span></span>

<span data-ttu-id="da10c-240">これらのコマンドはいずれも、entityFramework セクションを構成ファイルに追加し、必要に応じてプロバイダーコレクションを追加します。</span><span class="sxs-lookup"><span data-stu-id="da10c-240">Both these commands take care of adding an entityFramework section to the config file and adding a providers collection if necessary.</span></span>

<span data-ttu-id="da10c-241">これらのコマンドは install.ps1 NuGet スクリプトから呼び出されることを意図しています。</span><span class="sxs-lookup"><span data-stu-id="da10c-241">It is intended that these commands be called from the install.ps1 NuGet script.</span></span> <span data-ttu-id="da10c-242">たとえば、SQL Compact プロバイダーの install.ps1 は次のようになります。</span><span class="sxs-lookup"><span data-stu-id="da10c-242">For example, install.ps1 for the SQL Compact provider looks similar to this:</span></span>

``` powershell
param($installPath, $toolsPath, $package, $project)
Add-EFDefaultConnectionFactory $project 'System.Data.Entity.Infrastructure.SqlCeConnectionFactory, EntityFramework' -ConstructorArguments 'System.Data.SqlServerCe.4.0'
Add-EFProvider $project 'System.Data.SqlServerCe.4.0' 'System.Data.Entity.SqlServerCompact.SqlCeProviderServices, EntityFramework.SqlServerCompact'</pre>
```

<span data-ttu-id="da10c-243">これらのコマンドの詳細については、パッケージマネージャーコンソールウィンドウの get-help を使用して取得できます。</span><span class="sxs-lookup"><span data-stu-id="da10c-243">More information about these commands can be obtained by using get-help in the Package Manager Console window.</span></span>

## <a name="wrapping-providers"></a><span data-ttu-id="da10c-244">プロバイダーのラップ</span><span class="sxs-lookup"><span data-stu-id="da10c-244">Wrapping providers</span></span>

<span data-ttu-id="da10c-245">ラッピングプロバイダーは、既存のプロバイダーをラップして、プロファイリングやトレースなどの他の機能と共に拡張する EF や ADO.NET プロバイダーです。</span><span class="sxs-lookup"><span data-stu-id="da10c-245">A wrapping provider is an EF and/or ADO.NET provider that wraps an existing provider to extend it with other functionality such as profiling or tracing capabilities.</span></span> <span data-ttu-id="da10c-246">ラッププロバイダーは通常の方法で登録できますが、多くの場合、プロバイダー関連のサービスの解決をインターセプトして、実行時にラッピングプロバイダーを設定する方が便利です。</span><span class="sxs-lookup"><span data-stu-id="da10c-246">Wrapping providers can be registered in the normal way, but it is often more convenient to setup the wrapping provider at runtime by intercepting the resolution of provider-related services.</span></span> <span data-ttu-id="da10c-247">これを行うには、DbConfiguration クラスの静的イベント Onロック構成を使用できます。</span><span class="sxs-lookup"><span data-stu-id="da10c-247">The static event OnLockingConfiguration on the DbConfiguration class can be used to do this.</span></span>

<span data-ttu-id="da10c-248">Onlocked Configuration は、EF によって、アプリケーションドメインのすべての EF 構成がから取得され、使用のためにロックされる前に呼び出された後に呼び出されます。</span><span class="sxs-lookup"><span data-stu-id="da10c-248">OnLockingConfiguration is called after EF has determined where all EF configuration for the app domain will be obtained from but before it is locked for use.</span></span> <span data-ttu-id="da10c-249">アプリの起動時 (EF が使用される前) に、アプリはこのイベントのイベントハンドラーを登録する必要があります。</span><span class="sxs-lookup"><span data-stu-id="da10c-249">At app startup (before EF is used) the app should register an event handler for this event.</span></span> <span data-ttu-id="da10c-250">(ここでは、このハンドラーを構成ファイルに登録するためのサポートを追加することを検討していますが、これはまだサポートされていません)。その後、イベントハンドラーは、ラップする必要があるすべてのサービスに対して、交換用 Eservice を呼び出す必要があります。</span><span class="sxs-lookup"><span data-stu-id="da10c-250">(We are considering adding support for registering this handler in the config file but this is not yet supported.) The event handler should then make a call to ReplaceService for every service that needs to be wrapped.</span></span>  

<span data-ttu-id="da10c-251">たとえば、IDbConnectionFactory と DbProviderService をラップするには、次のようなハンドラーを登録する必要があります。</span><span class="sxs-lookup"><span data-stu-id="da10c-251">For example, to wrap IDbConnectionFactory and DbProviderService, a handler something like this should be registered:</span></span>

``` csharp
DbConfiguration.OnLockingConfiguration +=
    (_, a) =>
    {
        a.ReplaceService<DbProviderServices>(
            (s, k) => new MyWrappedProviderServices(s));

        a.ReplaceService<IDbConnectionFactory>(
            (s, k) => new MyWrappedConnectionFactory(s));
    };
```

<span data-ttu-id="da10c-252">解決済みで、サービスを解決するために使用されたキーと共にラップされる必要があるサービスは、ハンドラーに渡されます。</span><span class="sxs-lookup"><span data-stu-id="da10c-252">The service that has been resolved and should now be wrapped together with the key that was used to resolve the service are passed to the handler.</span></span> <span data-ttu-id="da10c-253">ハンドラーはこのサービスをラップし、返されたサービスをラップされたバージョンに置き換えることができます。</span><span class="sxs-lookup"><span data-stu-id="da10c-253">The handler can then wrap this service and replace the returned service with the wrapped version.</span></span>

## <a name="resolving-a-dbproviderfactory-with-ef"></a><span data-ttu-id="da10c-254">EF を使用した DbProviderFactory の解決</span><span class="sxs-lookup"><span data-stu-id="da10c-254">Resolving a DbProviderFactory with EF</span></span>

<span data-ttu-id="da10c-255">DbProviderFactory は、前の「 _プロバイダーの種類の概要_ 」で説明されているように、EF で必要とされる基本的なプロバイダーの種類の1つです。</span><span class="sxs-lookup"><span data-stu-id="da10c-255">DbProviderFactory is one of the fundamental provider types needed by EF as described in the _Provider types overview_ section above.</span></span> <span data-ttu-id="da10c-256">既に説明したように、これは EF 型ではなく、通常は EF 構成には含まれませんが、machine.config ファイルやアプリケーションの構成ファイルでの通常の ADO.NET プロバイダーの登録です。</span><span class="sxs-lookup"><span data-stu-id="da10c-256">As already mentioned, It is not an EF type and registration is usually not part of EF configuration, but is instead the normal ADO.NET provider registration in the machine.config file and/or application’s config file.</span></span>

<span data-ttu-id="da10c-257">ただし、この EF では、使用する DbProviderFactory を検索するときに通常の依存関係の解決メカニズムが使用されます。</span><span class="sxs-lookup"><span data-stu-id="da10c-257">Despite this EF still uses its normal dependency resolution mechanism when looking for a DbProviderFactory to use.</span></span> <span data-ttu-id="da10c-258">既定の競合回避モジュールでは、構成ファイルで通常の ADO.NET 登録が使用されるため、これは通常は透過的です。</span><span class="sxs-lookup"><span data-stu-id="da10c-258">The default resolver uses the normal ADO.NET registration in the config files and so this is usually transparent.</span></span> <span data-ttu-id="da10c-259">ただし、通常の依存関係の解決メカニズムが使用されているため、通常の ADO.NET 登録が完了していない場合でも、IDbDependencyResolver を使用して DbProviderFactory を解決できることを意味します。</span><span class="sxs-lookup"><span data-stu-id="da10c-259">But because of the normal dependency resolution mechanism is used it means that an IDbDependencyResolver can be used to resolve a DbProviderFactory even when normal ADO.NET registration has not been done.</span></span>

<span data-ttu-id="da10c-260">この方法で DbProviderFactory を解決すると、いくつかの影響があります。</span><span class="sxs-lookup"><span data-stu-id="da10c-260">Resolving DbProviderFactory in this way has several implications:</span></span>

*   <span data-ttu-id="da10c-261">コードベースの構成を使用するアプリケーションでは、DbConfiguration クラスに呼び出しを追加して、適切な DbProviderFactory を登録できます。</span><span class="sxs-lookup"><span data-stu-id="da10c-261">An application using code-based configuration can add calls in their DbConfiguration class to register the appropriate DbProviderFactory.</span></span> <span data-ttu-id="da10c-262">これは、ファイルベースの構成をまったく使用しない (または利用できない) アプリケーションに特に役立ちます。</span><span class="sxs-lookup"><span data-stu-id="da10c-262">This is especially useful for applications that do not want to (or cannot) make use of any file-based configuration at all.</span></span>
*   <span data-ttu-id="da10c-263">前の「 _プロバイダーのラップ_ 」セクションで説明されているように、サービスは置き換えることができます。</span><span class="sxs-lookup"><span data-stu-id="da10c-263">The service can be wrapped or replaced using ReplaceService as described in the _Wrapping providers_ section above</span></span>
*   <span data-ttu-id="da10c-264">理論的には、DbProviderServices の実装によって DbProviderFactory が解決する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="da10c-264">Theoretically, a DbProviderServices implementation could resolve a DbProviderFactory.</span></span>

<span data-ttu-id="da10c-265">これらのいずれかを実行する際に注意する必要がある重要な点は、EF による DbProviderFactory の参照のみに影響することです。</span><span class="sxs-lookup"><span data-stu-id="da10c-265">The important point to note about doing any of these things is that they will only affect the lookup of DbProviderFactory by EF.</span></span> <span data-ttu-id="da10c-266">EF 以外の他のコードでは、ADO.NET プロバイダーが通常の方法で登録されることを期待している場合があります。登録が見つからない場合は、失敗する可能性があります。</span><span class="sxs-lookup"><span data-stu-id="da10c-266">Other non-EF code may still expect the ADO.NET provider to be registered in the normal way and may fail if the registration is not found.</span></span> <span data-ttu-id="da10c-267">このため、通常は DbProviderFactory を通常の ADO.NET 方法で登録する方が適しています。</span><span class="sxs-lookup"><span data-stu-id="da10c-267">For this reason it is normally better for a DbProviderFactory to be registered in the normal ADO.NET way.</span></span>

### <a name="related-services"></a><span data-ttu-id="da10c-268">関連サービス</span><span class="sxs-lookup"><span data-stu-id="da10c-268">Related services</span></span>

<span data-ttu-id="da10c-269">EF を使用して DbProviderFactory を解決する場合は、IProviderInvariantName および IDbProviderFactoryResolver サービスも解決する必要があります。</span><span class="sxs-lookup"><span data-stu-id="da10c-269">If EF is used to resolve a DbProviderFactory, then it should also resolve the IProviderInvariantName and IDbProviderFactoryResolver services.</span></span>

<span data-ttu-id="da10c-270">IProviderInvariantName は、特定の種類の DbProviderFactory に対してプロバイダーの不変名を決定するために使用されるサービスです。</span><span class="sxs-lookup"><span data-stu-id="da10c-270">IProviderInvariantName is a service that is used to determine a provider invariant name for a given type of DbProviderFactory.</span></span> <span data-ttu-id="da10c-271">このサービスの既定の実装では、ADO.NET プロバイダーの登録が使用されます。</span><span class="sxs-lookup"><span data-stu-id="da10c-271">The default implementation of this service uses the ADO.NET provider registration.</span></span> <span data-ttu-id="da10c-272">これは、DbProviderFactory が EF によって解決されているために ADO.NET プロバイダーが通常の方法で登録されていない場合にも、このサービスを解決する必要があることを意味します。</span><span class="sxs-lookup"><span data-stu-id="da10c-272">This means that if the ADO.NET provider is not registered in the normal way because DbProviderFactory is being resolved by EF, then it will also be necessary to resolve this service.</span></span> <span data-ttu-id="da10c-273">DbConfiguration. SetProviderFactory メソッドを使用すると、このサービスのリゾルバーが自動的に追加されることに注意してください。</span><span class="sxs-lookup"><span data-stu-id="da10c-273">Note that a resolver for this service is automatically added when using the DbConfiguration.SetProviderFactory method.</span></span>

<span data-ttu-id="da10c-274">前の「 _プロバイダーの種類の概要_ 」で説明したように、IDbProviderFactoryResolver は、指定された DbConnection オブジェクトから正しい DbProviderFactory を取得するために使用されます。</span><span class="sxs-lookup"><span data-stu-id="da10c-274">As described in the _Provider types overview_ section above, the IDbProviderFactoryResolver is used to obtain the correct DbProviderFactory from a given DbConnection object.</span></span> <span data-ttu-id="da10c-275">.NET 4 で実行する場合のこのサービスの既定の実装では、ADO.NET プロバイダーの登録を使用します。</span><span class="sxs-lookup"><span data-stu-id="da10c-275">The default implementation of this service when running on .NET 4 uses the ADO.NET provider registration.</span></span> <span data-ttu-id="da10c-276">これは、DbProviderFactory が EF によって解決されているために ADO.NET プロバイダーが通常の方法で登録されていない場合にも、このサービスを解決する必要があることを意味します。</span><span class="sxs-lookup"><span data-stu-id="da10c-276">This means that if the ADO.NET provider is not registered in the normal way because DbProviderFactory is being resolved by EF, then it will also be necessary to resolve this service.</span></span>
